{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ëŒ€í™” ê²°ê³¼</title>
  <link rel="stylesheet" href="{% static 'chatapp/styles.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ë¡œê·¸ì¸/íšŒì›ê°€ì… ìš°ì¸¡ ìƒë‹¨ ì˜ì—­ */
    #authArea {
      position: absolute;
      top: 20px;
      right: 30px;
    }

    #authArea a {
      margin-left: 12px;
      text-decoration: none;
      color: #555;
      font-weight: bold;
    }

    #authArea a:hover {
      color: #ff6666;
    }
  </style>
</head>
<body>
  <!-- âœ… ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ + ê´€ë¦¬ì ë§í¬ -->
  <div id="authArea">
    {% if user.is_authenticated %}
      {{ user.username }}ë‹˜
      <a href="{% url 'logout' %}">ë¡œê·¸ì•„ì›ƒ</a>
      {% if user.is_superuser %}
        | <a href="/admin/">ê´€ë¦¬ì í˜ì´ì§€</a>
      {% endif %}
    {% else %}
      <a href="{% url 'login' %}">ë¡œê·¸ì¸</a>
      <a href="{% url 'signup' %}">íšŒì›ê°€ì…</a>
    {% endif %}
  </div>

  <h1>ëŒ€í™” ê²°ê³¼</h1>

  <!-- ìš”ì•½ ê²°ê³¼ -->
  <div id="summaryContent">
    <h2>ëŒ€í™” ìš”ì•½</h2>
    <p>{{ summary }}</p>
  </div>

  <!-- ê°ì • ë³€í™” ê·¸ë˜í”„ -->
  <h2>ê°ì • ë³€í™” ê·¸ë˜í”„</h2>
  <canvas id="emotionChart" width="800" height="300"></canvas>

  <button onclick="window.location.href='{% url 'index' %}'">ë‹¤ì‹œ ìƒë‹´í•˜ê¸°</button>

  <script>
    const emotionMap = {
      "ë¶„ë…¸": 0,
      "ë¶ˆì•ˆ": 1,
      "ìŠ¬í””": 2,
      "ìƒì²˜": 3,
      "ë‹¹í™©": 4,
      "ì¤‘ë¦½": 5,
      "ê¸°ì¨": 6
    };

    const emotionHistory = {{ emotion_history|safe }};
    console.log("ğŸ“Š ê°ì • ë°ì´í„°:", emotionHistory);

    const labels = emotionHistory.map(e => e.timestamp);
    const data = emotionHistory.map(e => emotionMap[e.sentiment] ?? 5); // ëª¨ë¥´ëŠ” ê°ì •ì€ ì¤‘ë¦½ ì²˜ë¦¬

    if (data.length === 1) {
      labels.push(labels[0] + " ");
      data.push(data[0]);
    }

    const ctx = document.getElementById("emotionChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "ê°ì • ë³€í™”",
          data: data,
          borderColor: "blue",
          backgroundColor: "rgba(0, 0, 255, 0.1)",
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          y: {
            min: 0,
            max: 6,
            ticks: {
              stepSize: 1,
              callback: function(value) {
                return Object.keys(emotionMap).find(key => emotionMap[key] === value);
              }
            },
            title: {
              display: true,
              text: "ê°ì •"
            }
          },
          x: {
            title: {
              display: true,
              text: "ì±„íŒ… ì‹œê°„ (HH:MM:SS)"
            }
          }
        }
      }
    });
  </script>
</body>
</html>
